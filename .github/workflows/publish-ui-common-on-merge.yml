#    Copyright 2025 Cognizant Technology Solutions Corp, www.cognizant.com.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.

# ================================================================================
# Publish UI Common on Merge Workflow
# ================================================================================
# Purpose: Automatically publish @cognizant-ai-lab/ui-common when ui-common code
#          changes are merged to main. This enables neuro-ui to always consume
#          the latest ui-common without manual version bumps.
#
# Trigger: Push to main branch with changes in packages/ui-common/**
#
# Version Format: <base>-main.<shortsha>.<runNumber> (e.g., 1.2.4-main.abc1234.123)
# Dist-tag: "main" (not "latest" - that's reserved for releases)
#
# After successful publish, triggers neuro-ui's update workflow via repository_dispatch.
# ================================================================================

name: Publish UI Common on Merge

on:
    push:
        branches:
            - main
        paths:
            - "packages/ui-common/**"

permissions:
    contents: read
    packages: write

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up yarn version
              run: |
                  corepack enable
                  corepack install
                  yarn --version

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.17.1
                  registry-url: https://npm.pkg.github.com/
                  scope: "@cognizant-ai-lab"
                  cache: yarn

            - name: Install dependencies
              run: |
                  rm -rf node_modules
                  yarn cache clean --all
                  yarn install --immutable

            - name: Generate OpenAPI types
              run: yarn generate

            - name: Compute version
              id: compute
              run: |
                  SHORT_SHA="$(git rev-parse --short "$GITHUB_SHA")"
                  # Read base version from ui-common/package.json
                  BASE_VERSION=$(node -e "console.log(require('./packages/ui-common/package.json').version)")
                  # Strip any existing prerelease suffix from base version
                  BASE_VERSION="${BASE_VERSION%%-*}"
                  # Create unique pre-release version: <base>-main.<sha>.<run>
                  VERSION="${BASE_VERSION}-main.${SHORT_SHA}.${{ github.run_number }}"
                  echo "version=$VERSION" >> "$GITHUB_OUTPUT"
                  echo "sha=$GITHUB_SHA" >> "$GITHUB_OUTPUT"
                  echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"
                  echo "Publishing version: $VERSION with dist-tag: main"

            - name: Set ui-common version
              run: ./build_scripts/set_package_version.sh packages/ui-common/package.json ${{ steps.compute.outputs.version }}

            - name: Build ui-common library
              run: yarn build:lib

            - name: Publish to GitHub Packages
              # Publish with dist-tag "main" so consumers can depend on @cognizant-ai-lab/ui-common@main
              # This keeps "latest" reserved for official releases
              run: yarn workspace @cognizant-ai-lab/ui-common npm publish --tag main
              env:
                  YARN_NPM_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Summary
              run: |
                  echo "### UI Common Published" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Version:** \`${{ steps.compute.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Dist-tag:** \`main\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** \`${{ steps.compute.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "This package can be installed with:" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  echo "yarn add @cognizant-ai-lab/ui-common@main" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    trigger-neuro-ui:
        needs: publish
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Compute SHA for dispatch
              id: sha
              run: |
                  echo "sha=$GITHUB_SHA" >> "$GITHUB_OUTPUT"
                  echo "short_sha=$(git rev-parse --short $GITHUB_SHA)" >> "$GITHUB_OUTPUT"

            - name: Trigger neuro-ui update workflow
              uses: peter-evans/repository-dispatch@v3
              with:
                  token: ${{ secrets.NEURO_UI_DISPATCH_TOKEN }}
                  repository: cognizant-ai-lab/neuro-ui
                  event-type: ui-common-commit
                  client-payload: '{"sha": "${{ steps.sha.outputs.sha }}", "short_sha": "${{ steps.sha.outputs.short_sha }}"}'

            - name: Summary
              run: |
                  echo "### Triggered neuro-ui Update" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Sent \`repository_dispatch\` event to \`cognizant-ai-lab/neuro-ui\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Event type:** \`ui-common-commit\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Payload SHA:** \`${{ steps.sha.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
