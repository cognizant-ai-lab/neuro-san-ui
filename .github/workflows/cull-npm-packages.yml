#    Copyright 2025 Cognizant Technology Solutions Corp, www.cognizant.com.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.

# ================================================================================
# Cull NPM Packages Workflow
# ================================================================================
# Purpose: Clean up old non-release npm packages to prevent package proliferation.
#
# Schedule: Runs weekly on Sunday at 00:00 UTC
#
# Retention Policy:
# - Release packages (version format: x.y.z) are NEVER deleted
# - Non-release packages (version format: x.y.z-main.sha.run or x.y.z-pr.sha.run):
#   - The most recent N packages are ALWAYS kept (regardless of age)
#   - Packages older than 14 days (beyond the most recent N) are deleted
#
# The workflow uses the GitHub API to list and delete package versions.
# ================================================================================

name: Cull NPM Packages

on:
    schedule:
        # Run weekly on Sunday at 00:00 UTC
        - cron: "0 0 * * 0"
    workflow_dispatch:
        inputs:
            dry_run:
                description: "Dry run (don't actually delete packages)"
                type: boolean
                default: true
            retention_days:
                description: "Delete non-release packages older than N days"
                type: number
                default: 14
            min_keep_versions:
                description: "Always keep at least N most recent non-release packages"
                type: number
                default: 5

env:
    PACKAGE_NAME: ui-common
    PACKAGE_OWNER: cognizant-ai-lab
    # Default retention period in days (can be overridden by workflow_dispatch input)
    DEFAULT_RETENTION_DAYS: 14
    # Default minimum versions to keep (can be overridden by workflow_dispatch input)
    DEFAULT_MIN_KEEP_VERSIONS: 5

permissions:
    packages: write

jobs:
    cull-packages:
        runs-on: ubuntu-latest
        steps:
            - name: Determine parameters
              id: params
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    DRY_RUN="${{ inputs.dry_run }}"
                    RETENTION_DAYS="${{ inputs.retention_days }}"
                    MIN_KEEP_VERSIONS="${{ inputs.min_keep_versions }}"
                  else
                    # Scheduled runs are NOT dry runs
                    DRY_RUN="false"
                    RETENTION_DAYS="${{ env.DEFAULT_RETENTION_DAYS }}"
                    MIN_KEEP_VERSIONS="${{ env.DEFAULT_MIN_KEEP_VERSIONS }}"
                  fi
                  echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT
                  echo "retention_days=$RETENTION_DAYS" >> $GITHUB_OUTPUT
                  echo "min_keep_versions=$MIN_KEEP_VERSIONS" >> $GITHUB_OUTPUT
                  echo "Dry run: $DRY_RUN"
                  echo "Retention days: $RETENTION_DAYS"
                  echo "Min keep versions: $MIN_KEEP_VERSIONS"

            - name: Calculate cutoff date
              id: cutoff
              run: |
                  RETENTION_DAYS="${{ steps.params.outputs.retention_days }}"
                  CUTOFF_DATE=$(date -d "$RETENTION_DAYS days ago" -u +%Y-%m-%dT%H:%M:%SZ)
                  echo "cutoff_date=$CUTOFF_DATE" >> $GITHUB_OUTPUT
                  echo "Cutoff date: $CUTOFF_DATE"
                  echo "Packages created before this date will be considered for deletion"

            - name: List and cull packages
              id: cull
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  PACKAGE_NAME="${{ env.PACKAGE_NAME }}"
                  PACKAGE_OWNER="${{ env.PACKAGE_OWNER }}"
                  CUTOFF_DATE="${{ steps.cutoff.outputs.cutoff_date }}"
                  DRY_RUN="${{ steps.params.outputs.dry_run }}"
                  MIN_KEEP_VERSIONS="${{ steps.params.outputs.min_keep_versions }}"

                  echo "Fetching package versions for @${PACKAGE_OWNER}/${PACKAGE_NAME}..."
                  echo "Retention policy: Keep last $MIN_KEEP_VERSIONS non-release versions, delete others older than $CUTOFF_DATE"

                  # Create temporary files for storing versions
                  RELEASE_FILE=$(mktemp)
                  NON_RELEASE_FILE=$(mktemp)
                  trap "rm -f $RELEASE_FILE $NON_RELEASE_FILE" EXIT

                  # Fetch all package versions (paginated) and categorize them
                  PAGE=1
                  PER_PAGE=100

                  while true; do
                    RESPONSE=$(gh api \
                      -H "Accept: application/vnd.github+json" \
                      -H "X-GitHub-Api-Version: 2022-11-28" \
                      "/orgs/${PACKAGE_OWNER}/packages/npm/${PACKAGE_NAME}/versions?per_page=${PER_PAGE}&page=${PAGE}" \
                      2>/dev/null || echo "[]")

                    if [ "$RESPONSE" = "[]" ] || [ -z "$RESPONSE" ]; then
                      break
                    fi

                    # Categorize each version as release or non-release
                    echo "$RESPONSE" | jq -c '.[]' | while read -r VERSION_JSON; do
                      VERSION_ID=$(echo "$VERSION_JSON" | jq -r '.id')
                      VERSION_NAME=$(echo "$VERSION_JSON" | jq -r '.name')
                      CREATED_AT=$(echo "$VERSION_JSON" | jq -r '.created_at')

                      # Check if this is a release version (format: x.y.z without any suffix)
                      if echo "$VERSION_NAME" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
                        echo "$VERSION_ID|$VERSION_NAME|$CREATED_AT" >> "$RELEASE_FILE"
                      else
                        echo "$VERSION_ID|$VERSION_NAME|$CREATED_AT" >> "$NON_RELEASE_FILE"
                      fi
                    done

                    # Check if there are more pages
                    VERSION_COUNT=$(echo "$RESPONSE" | jq 'length')
                    if [ "$VERSION_COUNT" -lt "$PER_PAGE" ]; then
                      break
                    fi
                    PAGE=$((PAGE + 1))
                  done

                  # Initialize counters
                  TOTAL_VERSIONS=0
                  RELEASE_VERSIONS=0
                  KEPT_VERSIONS=0
                  DELETED_VERSIONS=0
                  WOULD_DELETE_VERSIONS=0

                  # Process release versions (always keep)
                  echo ""
                  echo "=== Release Versions (always kept) ==="
                  if [ -s "$RELEASE_FILE" ]; then
                    RELEASE_VERSIONS=$(wc -l < "$RELEASE_FILE" | tr -d ' ')
                    TOTAL_VERSIONS=$((TOTAL_VERSIONS + RELEASE_VERSIONS))
                    while IFS='|' read -r VERSION_ID VERSION_NAME CREATED_AT; do
                      echo "KEEP (release): $VERSION_NAME (created: $CREATED_AT)"
                    done < "$RELEASE_FILE"
                  else
                    echo "No release versions found"
                  fi

                  # Process non-release versions
                  echo ""
                  echo "=== Non-Release Versions ==="
                  if [ -s "$NON_RELEASE_FILE" ]; then
                    # Sort by creation date (newest first) and save to a new temp file
                    # The created_at field is ISO 8601 format, so lexicographic sort works
                    SORTED_FILE=$(mktemp)
                    sort -t'|' -k3 -r "$NON_RELEASE_FILE" > "$SORTED_FILE"
                    NON_RELEASE_COUNT=$(wc -l < "$SORTED_FILE" | tr -d ' ')
                    TOTAL_VERSIONS=$((TOTAL_VERSIONS + NON_RELEASE_COUNT))
                    echo "Found $NON_RELEASE_COUNT non-release versions"
                    echo "Keeping at least $MIN_KEEP_VERSIONS most recent versions regardless of age"
                    echo ""

                    # Process each version using line numbers to track position
                    VERSION_INDEX=0
                    while IFS='|' read -r VERSION_ID VERSION_NAME CREATED_AT; do
                      VERSION_INDEX=$((VERSION_INDEX + 1))

                      # Always keep the first N versions (most recent)
                      if [ "$VERSION_INDEX" -le "$MIN_KEEP_VERSIONS" ]; then
                        echo "KEEP (min-keep #$VERSION_INDEX): $VERSION_NAME (created: $CREATED_AT)"
                        KEPT_VERSIONS=$((KEPT_VERSIONS + 1))
                        continue
                      fi

                      # For versions beyond the minimum keep count, apply age-based rule
                      if [[ "$CREATED_AT" < "$CUTOFF_DATE" ]]; then
                        if [ "$DRY_RUN" = "true" ]; then
                          echo "WOULD DELETE: $VERSION_NAME (created: $CREATED_AT)"
                          WOULD_DELETE_VERSIONS=$((WOULD_DELETE_VERSIONS + 1))
                        else
                          echo "DELETING: $VERSION_NAME (created: $CREATED_AT)"
                          gh api \
                            --method DELETE \
                            -H "Accept: application/vnd.github+json" \
                            -H "X-GitHub-Api-Version: 2022-11-28" \
                            "/orgs/${PACKAGE_OWNER}/packages/npm/${PACKAGE_NAME}/versions/${VERSION_ID}" \
                            2>/dev/null || echo "Failed to delete version $VERSION_NAME"
                          DELETED_VERSIONS=$((DELETED_VERSIONS + 1))
                        fi
                      else
                        echo "KEEP (recent): $VERSION_NAME (created: $CREATED_AT)"
                        KEPT_VERSIONS=$((KEPT_VERSIONS + 1))
                      fi
                    done < "$SORTED_FILE"
                    rm -f "$SORTED_FILE"
                  else
                    echo "No non-release versions found"
                  fi

                  # Output summary
                  echo ""
                  echo "=== Summary ==="
                  echo "Total versions processed: $TOTAL_VERSIONS"
                  echo "Release versions (kept): $RELEASE_VERSIONS"
                  echo "Non-release versions kept: $KEPT_VERSIONS"
                  if [ "$DRY_RUN" = "true" ]; then
                    echo "Versions that would be deleted: $WOULD_DELETE_VERSIONS"
                  else
                    echo "Versions deleted: $DELETED_VERSIONS"
                  fi

                  # Set outputs for summary
                  echo "total=$TOTAL_VERSIONS" >> $GITHUB_OUTPUT
                  echo "release=$RELEASE_VERSIONS" >> $GITHUB_OUTPUT
                  echo "kept=$KEPT_VERSIONS" >> $GITHUB_OUTPUT
                  echo "deleted=$DELETED_VERSIONS" >> $GITHUB_OUTPUT
                  echo "would_delete=$WOULD_DELETE_VERSIONS" >> $GITHUB_OUTPUT

            - name: Summary
              if: always()
              run: |
                  DRY_RUN="${{ steps.params.outputs.dry_run }}"
                  RETENTION_DAYS="${{ steps.params.outputs.retention_days }}"
                  MIN_KEEP_VERSIONS="${{ steps.params.outputs.min_keep_versions }}"
                  CUTOFF_DATE="${{ steps.cutoff.outputs.cutoff_date }}"

                  echo "### NPM Package Cull Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Package:** \`@${{ env.PACKAGE_OWNER }}/${{ env.PACKAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Retention Period:** ${RETENTION_DAYS} days" >> $GITHUB_STEP_SUMMARY
                  echo "**Min Keep Versions:** ${MIN_KEEP_VERSIONS}" >> $GITHUB_STEP_SUMMARY
                  echo "**Cutoff Date:** \`${CUTOFF_DATE}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "$DRY_RUN" = "true" ]; then
                    echo "**Mode:** Dry Run (no packages were deleted)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "**Mode:** Live Run" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  echo "#### Retention Policy" >> $GITHUB_STEP_SUMMARY
                  echo "- Release versions (format \`x.y.z\`) are **never** deleted" >> $GITHUB_STEP_SUMMARY
                  echo "- The most recent ${MIN_KEEP_VERSIONS} non-release versions are **always** kept" >> $GITHUB_STEP_SUMMARY
                  echo "- Non-release versions older than ${RETENTION_DAYS} days (beyond the min keep) are deleted" >> $GITHUB_STEP_SUMMARY
