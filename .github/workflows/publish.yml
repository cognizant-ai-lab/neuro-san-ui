#    Copyright 2025 Cognizant Technology Solutions Corp, www.cognizant.com.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.

# This workflow publishes the package to GitHub Packages when a release is published
# or when called by the orchestrator workflow on merge to main.

name: Publish Package

on:
    release:
        types: [published]
    workflow_call:

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  registry-url: https://npm.pkg.github.com/
                  scope: "@cognizant-ai-lab"

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            #            - name: Build
            #              run: yarn build

            - name: Determine version
              id: version
              run: |
                  if [ "${{ github.event_name }}" == "release" ]; then
                    echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
                  else
                    # For workflow_call, use the current package version
                    VERSION=$(node -p "require('./packages/ui-common/package.json').version")
                    echo "version=$VERSION" >> $GITHUB_OUTPUT
                  fi

            - name: Publish to GitHub Packages
              run: yarn workspace @cognizant-ai-lab/ui-common npm publish
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
